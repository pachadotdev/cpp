<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>01 - Motivations for cpp4r • cpp4r</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="01 - Motivations for cpp4r">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cpp4r</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-motivations.html">01 - Motivations for cpp4r</a></li>
    <li><a class="dropdown-item" href="../articles/02-setup.html">02 - Setup</a></li>
    <li><a class="dropdown-item" href="../articles/03-package-skeleton.html">03 - Package Skeleton</a></li>
    <li><a class="dropdown-item" href="../articles/04-read-only.html">04 - Read-only versus Writable R Objects</a></li>
    <li><a class="dropdown-item" href="../articles/05-logical-functions.html">05 - Logical Functions</a></li>
    <li><a class="dropdown-item" href="../articles/06-rolling-functions.html">06 - Rolling Functions</a></li>
    <li><a class="dropdown-item" href="../articles/07-statistical-functions.html">07 - Statistical Functions</a></li>
    <li><a class="dropdown-item" href="../articles/08-logical-functions-2.html">08 - Logical Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/09-rolling-functions-2.html">09 - Rolling Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/10-statistical-functions-2.html">10 - Statistical Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/11-debugging.html">11 - Debugging R Packages</a></li>
    <li><a class="dropdown-item" href="../articles/12-external-pointers.html">12 - External Pointers</a></li>
    <li><a class="dropdown-item" href="../articles/13-compiler-optimization.html">13 - Compiler Optimizations</a></li>
    <li><a class="dropdown-item" href="../articles/14-linear-algebra.html">14 - Linear Algebra</a></li>
    <li><a class="dropdown-item" href="../articles/15-internals.html">15 - Internals</a></li>
    <li><a class="dropdown-item" href="../articles/16-FAQ.html">17 - FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/17-worked-examples.html">16 - Worked Examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/pachadotdev/cpp4r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">



<script src="01-motivations_files/kePrint-0.0.1/kePrint.js"></script><link href="01-motivations_files/lightable-0.0.1/lightable.css" rel="stylesheet">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>01 - Motivations for cpp4r</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pachadotdev/cpp4r/blob/HEAD/vignettes/01-motivations.Rmd"><code>vignettes/01-motivations.Rmd</code></a></small>
      <div class="d-none name"><code>01-motivations.Rmd</code></div>
    </div>

    
    
<div class="section level3">
<h3 id="motivation-and-significance">Motivation and significance<a class="anchor" aria-label="anchor" href="#motivation-and-significance"></a>
</h3>
<p>The R programming language has maintained a long-standing tradition
of interfacing with compiled languages, dating back to the original S
implementation in the late 1970s, which served primarily as a wrapper
around FORTRAN routines <span class="citation">(Chambers 2006)</span>.
This integration remains relevant today, as R code sometimes lacks the
performance needed for computationally intensive tasks. Even after
optimizing R code through vectorization and avoiding unnecessary object
copying, bottlenecks may persist that require compiled language
solutions.</p>
<p>C++ offers particular advantages for addressing common R performance
bottlenecks, including:</p>
<ul>
<li>Loops that cannot be easily vectorized due to dependencies between
iterations</li>
<li>Recursive functions or problems requiring many function calls</li>
<li>Data structures and algorithms not natively available in R (e.g., R
does not let the end-user use pointers and pass-by-reference
semantics)</li>
<li>Problems requiring fine-tuning memory management</li>
</ul>
<p>cpp4r is an R package that provides C++11 bindings to R, enabling the
use of C++ code in R packages. It is a fork of the cpp11 package <span class="citation">(Vaughan, Hester, and François 2025)</span> aiming to
provide additional features and improvements while maintaining
compatibility with the original cpp11 API.</p>
<p>The landscape of C++ bindings for R has evolved significantly over
the past two decades. The cxx package, released in 2000, provided an
early prototype of C++ bindings <span class="citation">(Hornik
2001)</span>. Rcpp, first published to CRAN in 2008, became the
mainstream solution with over 2,000 reverse dependencies by 2020 <span class="citation">(Eddelbuettel and Francois 2011)</span>. A subsequent
attempt, Rcpp11, was released in 2014 but did not achieve widespread
adoption <span class="citation">(Francois, Ushey, and Chambers
2020)</span>.</p>
<p>While Rcpp has been highly successful, adding modern C++ features or
addressing certain architectural issues would require substantial
breaking changes to maintain backward compatibility with the extensive
ecosystem of dependent packages.</p>
<p>To address these limitations, the cpp11 package <span class="citation">(Vaughan, Hester, and François 2023)</span> was
released in 2023 as a reimplementation of C++ bindings to R,
incorporating modern C++ features and different design trade-offs aiming
to provide:</p>
<ul>
<li>Enforced copy-on-write semantics consistent with R’s behavior</li>
<li>Improved safety when interfacing with R’s C API</li>
<li>Native support for ALTREP objects</li>
<li>UTF-8 string handling throughout</li>
<li>Modern C++11 features and idioms</li>
<li>Simplified implementation compared to Rcpp</li>
<li>Faster compilation with reduced memory requirements</li>
<li>Completely header-only design to avoid Application Binary Interface
(ABI) compatibility issues</li>
</ul>
</div>
<div class="section level3">
<h3 id="software-description">Software description<a class="anchor" aria-label="anchor" href="#software-description"></a>
</h3>
<p>While using cpp11 to keep my thesis project minimal in terms of code
duplication and reusing existing components instead, I identified
several enhancements that could benefit the R community and improve the
usability of the library including:</p>
<ul>
<li>Support for converting C++ standard containers (maps) to R
lists</li>
<li>Roxygen documentation support directly in C++ code</li>
<li>Proper handling of matrix attributes</li>
<li>Support for nullable external pointers</li>
<li>Immediate availability of values added via
<code>push_back()</code>
</li>
<li>Bidirectional copy of complex number types</li>
<li>Flexibility in type conversions</li>
<li>Various performance optimizations</li>
</ul>
<p>After discussing these proposed enhancements with the cpp11
maintainers, it became clear that the development priorities and
timelines would not accommodate these features in the near term. This
led to the creation of cpp4r, a fork of cpp11 that incorporates these
additional features while maintaining compatibility with the original
cpp11 API. This means that cpp4r can serve as a drop-in replacement for
cpp11 in any case, allowing users to benefit from the enhancements
without significant code changes. The converse, replacing cpp4r with
cpp11, requires adjustments due to the additional features in cpp4r.</p>
<p>cpp4r extends cpp11’s container support by enabling seamless
conversion between C++ standard library containers and R objects. This
includes support for <code>std::map</code> and
<code>std::unordered_map</code> containers, which are automatically
converted to named R lists.</p>
<p>cpp4r provides roxygen support directly in C++ code, allowing
developers to document their C++ functions using familiar roxygen2
syntax. This integration streamlines the documentation workflow for
packages that expose C++ functions to R.</p>
<p>Unlike cpp11, cpp4r properly handles matrix attributes, including
<code>dimnames</code>, ensuring that matrix operations preserve metadata
when copying data between R and C++.</p>
<p>cpp4r offers more flexible type conversion functions. For example,
<code>as_integers()</code> and <code>as_doubles()</code> accept logical
inputs, providing greater flexibility in handling diverse input types
compared to the more restrictive cpp11 implementations.</p>
<p>Several internal optimizations improve performance over cpp11,
particularly in vector operations and memory management. These
optimizations maintain the safety guarantees of cpp11 while improving
execution speed.</p>
<p>cpp4r provides full bidirectional copy of complex numbers, enabling
seamless copy of complex vectors and matrices between R and C++ code. On
the contrary, cpp11 does not support copying complex numbers from R to
C++ or vice versa.</p>
<p>cpp4r maintains cpp11’s core design principles while extending
functionality:</p>
<ul>
<li>Copy-on-Write Semantics: Like cpp11, cpp4r enforces copy-on-write
semantics that match R’s behavior, preventing unexpected modifications
to input data.</li>
<li>Safety First: cpp4r incorporates comprehensive safety mechanisms
when interfacing with R’s C API, using <code>unwind_protect()</code> and
exception handling to prevent resource leaks.</li>
<li>Modern C++ Features: The implementation leverages C++11 features
including move semantics, type traits, variadic templates, and
user-defined literals.</li>
<li>Header-Only Design: As a completely header-only library, cpp4r
avoids ABI compatibility issues that can arise with libraries containing
compiled components.</li>
</ul>
<p>cpp4r offers vendoring capabilities, which means that you copy the
code for the dependencies into your project’s source tree. This idea
comes from the Go programming language, where it is a common practice to
included the dependencies’ headers with the source code <span class="citation">(The Go Authors 2024)</span>. This ensures the
dependency code is fixed and stable until it is updated. This feature is
possible because cpp4r is a header-only library, allowing you to copy
all headers by running <code>cpp4r::vendor_cpp4r()</code> if you need
this option.</p>
<p>Vendoring has advantages and drawbacks however. The advantage is that
unlikely disruptive changes to the cpp4r project could never break your
existing code. The drawbacks are that the package size will be slightly
larger and isolated from bugfixes and/or new features until you
explicitly update the vendored headers. The majority of packages should
not vendor the cpp4r dependency, unless those are designed to run within
restricted environments where internet access is limited or unavailable
for security reasons (e.g., high-performance computing clusters).</p>
</div>
<div class="section level3">
<h3 id="software-functionalities">Software functionalities<a class="anchor" aria-label="anchor" href="#software-functionalities"></a>
</h3>
<p>cpp4r is designed as a drop-in replacement for cpp11, using identical
syntax and API patterns. Existing cpp11 code can typically be migrated
to cpp4r with minimal changes, primarily involving header includes and
namespace references.</p>
<p>To use cpp4r, users must first install the package from CRAN or
GitHub. The following code shows how to install the package:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"cpp4r"</span>, repos <span class="op">=</span> <span class="st">"https://cran.rstudio.com"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># or</span></span>
<span><span class="fu">remotes</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html">install_github</a></span><span class="op">(</span><span class="st">"pachadotdev/cpp4r"</span><span class="op">)</span></span></code></pre></div>
<p>Once installed, users can use the provided package template function
to create a new package that uses C++ code. The package template
includes simple examples and all the necessary files to compile the code
and install the new R package. The following code shows how to create a
new package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">cpp4r</span><span class="fu">::</span><span class="fu"><a href="../reference/pkg_template.html">pkg_template</a></span><span class="op">(</span><span class="st">"~/rstats/mypkg"</span><span class="op">)</span></span></code></pre></div>
<p>The package skeleton includes standard practices:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># In DESCRIPTION file</span></span>
<span><span class="va">LinkingTo</span><span class="op">:</span> <span class="va">cpp4r</span></span>
<span></span>
<span><span class="co"># In R code</span></span>
<span><span class="co">#' @useDynLib mypkg, .registration = TRUE</span></span>
<span><span class="co">#' @keywords internal</span></span>
<span><span class="st">"_PACKAGE"</span></span></code></pre></div>
<p>C++ functions are exposed to R using the attribute syntax and
documented with roxygen comments:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">@title Square of Each Element in 'x'</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">@param x Numeric vector</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">@return Numeric vector</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>cpp4r<span class="op">::</span>doubles my_square<span class="op">(</span>cpp4r<span class="op">::</span>doubles x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The equivalent cpp11 code would be:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp11</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>cpp11<span class="op">::</span>doubles my_square_cpp<span class="op">(</span>cpp11<span class="op">::</span>doubles x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="cf">return</span> x <span class="op">*</span> x<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' @title Square of Each Element in 'x</span></span>
<span><span class="co">#' @param x Numeric vector</span></span>
<span><span class="co">#' @return Numeric vector</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">my_square</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">my_square_cpp</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="illustrative-examples">Illustrative examples<a class="anchor" aria-label="anchor" href="#illustrative-examples"></a>
</h3>
<p>cpp4r uses a custom double linked list data structure to track
objects it is managing. This structure is more efficient for large
numbers of objects than using
<code>R_PreserveObject()</code>/<code>R_ReleaseObjects()</code> as it is
done in Rcpp.</p>
<p>For problems where we know the vectors or matrices size beforehand,
the performance difference between cpp4r/cpp11 and Rcpp is negligible.
However, when the length of the vectors (or matrices) is not known
beforehand, the performance changes notably, and such is the case of the
rejection sampling algorithm which consists in obtaining
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
accepted samples without the possibility to know beforehand how many
candidates we need to generate.</p>
<p>The C++ <code>push_back()</code> method is ideal for cases such as
rejection sampling, each candidate is either accepted (stored) or
rejected (discarded), and in a low acceptance rates we might need to
generate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">kn</annotation></semantics></math>
candidates
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>&gt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k &gt; 1</annotation></semantics></math>)
than the
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
final samples. Unlike Gibbs sampling algorithms, where we know the
iterations upfront, rejection sampling genuinely requires dynamic growth
vectors or matrices. For example, with an acceptance rate of 80%, we
would need to generate approximately
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1.25</mn><mi>n</mi></mrow><annotation encoding="application/x-tex">1.25 n</annotation></semantics></math>
samples to obtain
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
final samples.</p>
<p>Rejection sampling is used in Monte Carlo methods, Bayesian
inference, and simulation studies where cpp4r design is handy as it
reserves extra memory making <code>push_back()</code> operations within
it have a time complexity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math>.
On the contrary, Rcpp does not reserve extra capacity and its
<code>push_back()</code> operations have a time complexity
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>n</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math>
that leads to a quadratic pattern in memory usage with the number of
input elements. This design difference translates in performance
differences with larger input data.</p>
<p>The following code shows a rejection sampling implementation with
lower and upper truncation bounds using cpp4r (it is equivalent for
cpp11 and Rcpp):</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">// Reproducible examples via set.seed() in R</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="kw">class</span> local_rng <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a> <span class="kw">public</span><span class="op">:</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  local_rng<span class="op">()</span> <span class="op">{</span> GetRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="op">~</span>local_rng<span class="op">()</span> <span class="op">{</span> PutRNGstate<span class="op">();</span> <span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> doubles rejection_sampling_cpp4r<span class="op">(</span><span class="dt">int</span> n_samples<span class="op">,</span> <span class="dt">double</span> mu <span class="op">=</span> <span class="fl">0.0</span><span class="op">,</span> </span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>                                                     <span class="dt">double</span> sigma <span class="op">=</span> <span class="fl">1.0</span><span class="op">,</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>                                                     <span class="dt">double</span> lower <span class="op">=</span> <span class="op">-</span><span class="fl">2.0</span><span class="op">,</span> </span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>                                                     <span class="dt">double</span> upper <span class="op">=</span> <span class="fl">2.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  local_rng rng_state<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  </span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="co">// Acceptance rate for better initial allocation</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="dt">double</span> z_lower <span class="op">=</span> <span class="op">(</span>lower <span class="op">-</span> mu<span class="op">)</span> <span class="op">/</span> sigma<span class="op">,</span> z_upper <span class="op">=</span> <span class="op">(</span>upper <span class="op">-</span> mu<span class="op">)</span> <span class="op">/</span> sigma<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  <span class="dt">double</span> acceptance_rate <span class="op">=</span> Rf_pnorm5<span class="op">(</span>z_upper<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">-</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>    Rf_pnorm5<span class="op">(</span>z_lower<span class="op">,</span> <span class="fl">0.0</span><span class="op">,</span> <span class="fl">1.0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  </span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>  <span class="co">// Allocate based on expected number of samples needed (add 20% to ensure minimum size)</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>  <span class="dt">R_xlen_t</span> estimated_needed <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">R_xlen_t</span><span class="op">&gt;(</span>n_samples <span class="op">/</span> acceptance_rate <span class="op">*</span> <span class="fl">1.2</span><span class="op">);</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>  estimated_needed <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>estimated_needed<span class="op">,</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">R_xlen_t</span><span class="op">&gt;(</span>n_samples<span class="op">));</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>  </span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  writable<span class="op">::</span>doubles accepted_samples<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  accepted_samples<span class="op">.</span>reserve<span class="op">(</span>estimated_needed<span class="op">);</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  <span class="co">// Keep sampling until we have enough accepted samples</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>  <span class="dt">int</span> target_samples <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>n_samples<span class="op">);</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  </span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">int</span><span class="op">&gt;(</span>accepted_samples<span class="op">.</span>size<span class="op">())</span> <span class="op">&lt;</span> target_samples<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    <span class="dt">double</span> candidate <span class="op">=</span> Rf_rnorm<span class="op">(</span>mu<span class="op">,</span> sigma<span class="op">);</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>    </span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>candidate <span class="op">&gt;=</span> lower <span class="op">&amp;&amp;</span> candidate <span class="op">&lt;=</span> upper<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>      accepted_samples<span class="op">.</span>push_back<span class="op">(</span>candidate<span class="op">);</span></span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>  </span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>  <span class="cf">return</span> accepted_samples<span class="op">;</span></span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The following table shows the speed quantiles for the same rejection
sampling algorithm implemented with cpp4r, cpp11, and Rcpp:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://scales.r-lib.org">scales</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'scales'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:purrr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     discard</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://bench.r-lib.org/">bench</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://haozhu233.github.io/kableExtra/">kableExtra</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'kableExtra'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     group_rows</span></span>
<span></span>
<span><span class="va">rejection_bench</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"rejection_bench.rds"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rejection_bench</span> <span class="op">&lt;-</span> <span class="va">rejection_bench</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">expression</span>, <span class="va">len</span>, <span class="va">median</span>, <span class="va">mem_alloc</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">expression</span><span class="op">)</span>,</span>
<span>    len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/formatc.html">formatC</a></span><span class="op">(</span><span class="va">len</span>, format <span class="op">=</span> <span class="st">"d"</span>, big.mark <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    expression <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">expression</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"cpp4r"</span>, <span class="st">"cpp11"</span>, <span class="st">"Rcpp"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    len <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">len</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"25,000"</span>, <span class="st">"50,000"</span>, <span class="st">"75,000"</span>, <span class="st">"100,000"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">expression</span>, <span class="va">len</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rejection_bench</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html">kable</a></span><span class="op">(</span>align <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"l"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="st">"r"</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>, booktabs <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Backend"</span>, <span class="st">"Sample size"</span>, <span class="st">"Median speed"</span>, <span class="st">"Cumulative memory usage"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/kable_styling.html">kable_styling</a></span><span class="op">(</span>latex_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"hold_position"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/kableExtra/man/collapse_rows.html">collapse_rows</a></span><span class="op">(</span>columns <span class="op">=</span> <span class="fl">1</span>, valign <span class="op">=</span> <span class="st">"middle"</span>, latex_hline <span class="op">=</span> <span class="st">"major"</span><span class="op">)</span></span></code></pre></div>
<table class="table table" style="margin-left: auto; margin-right: auto;">
<thead><tr>
<th style="text-align:left;">
Backend
</th>
<th style="text-align:right;">
Sample size
</th>
<th style="text-align:right;">
Median speed
</th>
<th style="text-align:right;">
Cumulative memory usage
</th>
</tr></thead>
<tbody>
<tr>
<td style="text-align:left;vertical-align: middle !important;" rowspan="4">
cpp4r
</td>
<td style="text-align:right;">
25,000
</td>
<td style="text-align:right;">
808.53µs
</td>
<td style="text-align:right;">
468.96KB
</td>
</tr>
<tr>
<td style="text-align:right;">
50,000
</td>
<td style="text-align:right;">
2.17ms
</td>
<td style="text-align:right;">
931.76KB
</td>
</tr>
<tr>
<td style="text-align:right;">
75,000
</td>
<td style="text-align:right;">
2.75ms
</td>
<td style="text-align:right;">
1.36MB
</td>
</tr>
<tr>
<td style="text-align:right;">
100,000
</td>
<td style="text-align:right;">
3.57ms
</td>
<td style="text-align:right;">
1.82MB
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: middle !important;" rowspan="4">
cpp11
</td>
<td style="text-align:right;">
25,000
</td>
<td style="text-align:right;">
806.16µs
</td>
<td style="text-align:right;">
714.71KB
</td>
</tr>
<tr>
<td style="text-align:right;">
50,000
</td>
<td style="text-align:right;">
2.6ms
</td>
<td style="text-align:right;">
1.38MB
</td>
</tr>
<tr>
<td style="text-align:right;">
75,000
</td>
<td style="text-align:right;">
2.77ms
</td>
<td style="text-align:right;">
2.57MB
</td>
</tr>
<tr>
<td style="text-align:right;">
100,000
</td>
<td style="text-align:right;">
3.98ms
</td>
<td style="text-align:right;">
2.76MB
</td>
</tr>
<tr>
<td style="text-align:left;vertical-align: middle !important;" rowspan="4">
Rcpp
</td>
<td style="text-align:right;">
25,000
</td>
<td style="text-align:right;">
420.98ms
</td>
<td style="text-align:right;">
2.33GB
</td>
</tr>
<tr>
<td style="text-align:right;">
50,000
</td>
<td style="text-align:right;">
1.52s
</td>
<td style="text-align:right;">
9.32GB
</td>
</tr>
<tr>
<td style="text-align:right;">
75,000
</td>
<td style="text-align:right;">
4.04s
</td>
<td style="text-align:right;">
20.96GB
</td>
</tr>
<tr>
<td style="text-align:right;">
100,000
</td>
<td style="text-align:right;">
6.01s
</td>
<td style="text-align:right;">
37.26GB
</td>
</tr>
</tbody>
</table>
<p>The benchmark reveals that both cpp4r and cpp11 exhibit better
scaling compared to Rcpp, showing how a different approach makes a
difference when we require repeated calls to <code>push_back()</code>,
as with Rcpp the entire vector has to be copied on each call. In
contrast <code>cpp4r</code> vectors grow efficiently, reserving extra
space as <code>std::vector</code> does.</p>
</div>
<div class="section level3">
<h3 id="impact">Impact<a class="anchor" aria-label="anchor" href="#impact"></a>
</h3>
<p>By providing a portable interface for C++ integration, cpp4r enables
R developers to leverage the power of modern C++ while minimizing the
complexity typically associated with writing compiled code. The
benchmarks demonstrate substantial speed and memory usage improvements
compared to existing implementations, providing researchers with a
useful tool to write R packages to analyze large datasets and intensive
computations.</p>
<p>Besides the better use of RAM, which can make a difference between
being able to run an analysis or not, cpp4r’s design also offers faster
compilation times, which can significantly enhance the development
workflow and testing. This is particularly beneficial in academic and
business settings, where prototyping and iteration often precede the
final implementation.</p>
<p>cpp4r represents an evolution in C++ bindings for R, building upon
the solid foundation established by cpp11 while addressing specific
limitations and adding features that can benefit the R community. By
maintaining API compatibility with cpp11, cpp4r provides a migration
path for developers seeking enhanced functionality without requiring
significant code restructuring.</p>
</div>
<div class="section level3">
<h3 id="conclusion">Conclusion<a class="anchor" aria-label="anchor" href="#conclusion"></a>
</h3>
<p>The development of cpp4r demonstrates the value of open-source
transparency and how it enabled derived works. While cpp11 and Rcpp
continue to serve the broader R community effectively, cpp4r offers an
alternative for projects requiring its specific enhancements,
particularly in academic research contexts where documentation features
and additional data types support reduces the coding effort for
advancing computational methods.</p>
</div>
<div class="section level2">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-chambers06" class="csl-entry">
Chambers, John. 2006. <span>“A <span>History</span> of <span>S</span>
and <span>R</span> (with Some Questions for the Future).”</span> Vienna,
Austria. <a href="https://www.r-project.org/conferences/useR-2006/Presentations/index.html">https://www.r-project.org/conferences/useR-2006/Presentations/index.html</a>.
</div>
<div id="ref-eddelbuettel11" class="csl-entry">
Eddelbuettel, Dirk, and Romain Francois. 2011. <span>“Rcpp:
<span>Seamless</span> <span>R</span> and <span>C++</span>
<span>Integration</span>.”</span> <em>Journal of Statistical
Software</em> 40 (April): 1–18. <a href="https://doi.org/10.18637/jss.v040.i08">https://doi.org/10.18637/jss.v040.i08</a>.
</div>
<div id="ref-francois20" class="csl-entry">
Francois, Romain, Kevin Ushey, and John Chambers. 2020. <span>“Rcpp11:
<span>R</span> and <span>C</span>++11.”</span> <a href="https://cran.r-project.org/web/packages/Rcpp11/index.html">https://cran.r-project.org/web/packages/Rcpp11/index.html</a>.
</div>
<div id="ref-hornik01" class="csl-entry">
Hornik, Kurt. 2001. <span>“Cxx: <span>C</span>++ Test.”</span> <a href="https://cran.r-project.org/src/contrib/Archive/cxx/">https://cran.r-project.org/src/contrib/Archive/cxx/</a>.
</div>
<div id="ref-go24" class="csl-entry">
The Go Authors. 2024. <span>“Go <span>Modules</span>
<span>Reference</span>.”</span> <a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a>.
</div>
<div id="ref-cpp1123" class="csl-entry">
Vaughan, Davis, Jim Hester, and Romain François. 2023. <em>‘Cpp11‘: A
<span>C++</span>11 Interface for <span>R</span>’s c Interface</em>. <a href="https://CRAN.R-project.org/package=cpp11">https://CRAN.R-project.org/package=cpp11</a>.
</div>
<div id="ref-cpp1125" class="csl-entry">
———. 2025. <em>‘Cpp11‘: A <span>C++</span>11 Interface for
<span>R</span>’s c Interface</em>. <a href="https://CRAN.R-project.org/package=cpp11">https://CRAN.R-project.org/package=cpp11</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mauricio Vargas Sepulveda, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
