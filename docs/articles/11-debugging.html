<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>11 - Debugging R Packages • cpp4r</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="11 - Debugging R Packages">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">cpp4r</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01-motivations.html">01 - Motivations for cpp4r</a></li>
    <li><a class="dropdown-item" href="../articles/02-setup.html">02 - Setup</a></li>
    <li><a class="dropdown-item" href="../articles/03-package-skeleton.html">03 - Package Skeleton</a></li>
    <li><a class="dropdown-item" href="../articles/04-read-only.html">04 - Read-only versus Writable R Objects</a></li>
    <li><a class="dropdown-item" href="../articles/05-logical-functions.html">05 - Logical Functions</a></li>
    <li><a class="dropdown-item" href="../articles/06-rolling-functions.html">06 - Rolling Functions</a></li>
    <li><a class="dropdown-item" href="../articles/07-statistical-functions.html">07 - Statistical Functions</a></li>
    <li><a class="dropdown-item" href="../articles/08-logical-functions-2.html">08 - Logical Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/09-rolling-functions-2.html">09 - Rolling Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/10-statistical-functions-2.html">10 - Statistical Functions with Missing Values</a></li>
    <li><a class="dropdown-item" href="../articles/11-debugging.html">11 - Debugging R Packages</a></li>
    <li><a class="dropdown-item" href="../articles/12-external-pointers.html">12 - External Pointers</a></li>
    <li><a class="dropdown-item" href="../articles/13-compiler-optimization.html">13 - Compiler Optimizations</a></li>
    <li><a class="dropdown-item" href="../articles/14-linear-algebra.html">14 - Linear Algebra</a></li>
    <li><a class="dropdown-item" href="../articles/15-internals.html">15 - Internals</a></li>
    <li><a class="dropdown-item" href="../articles/16-FAQ.html">17 - FAQs</a></li>
    <li><a class="dropdown-item" href="../articles/17-worked-examples.html">16 - Worked Examples</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="nav-link" href="https://github.com/pachadotdev/cpp4r/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>11 - Debugging R Packages</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/pachadotdev/cpp4r/blob/HEAD/vignettes/11-debugging.Rmd"><code>vignettes/11-debugging.Rmd</code></a></small>
      <div class="d-none name"><code>11-debugging.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>The previous package skeleton left out some essential details, such
as testing for memory leaks and debugging. This vignette will cover
these aspects in more detail. The references for this vignette are <span class="citation">(<strong>vaughan?</strong>)</span>, <span class="citation">(<strong>padgham?</strong>)</span>, <span class="citation">(<strong>vaughan2?</strong>)</span>, <span class="citation">(<strong>wickham?</strong>)</span>, and <span class="citation">(<strong>rpkgdevel?</strong>)</span>.</p>
</div>
<div class="section level2">
<h2 id="compiler-setup">Compiler Setup<a class="anchor" aria-label="anchor" href="#compiler-setup"></a>
</h2>
<p>To test that your functions do not lead to memory errors, you can
create/edit a <code>src/Makevars.in</code> file within the package
folder and add:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="ex">PKG_CXXFLAGS</span> = <span class="at">-Wall</span> <span class="at">-O0</span> <span class="at">-pedantic</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="ex">PKG_CPPFLAGS</span> = <span class="at">-UDEBUG</span> <span class="at">-g</span></span></code></pre></div>
<p>On Windows, the file is <code>src/Makevars.win</code> and the content
is the same.</p>
<p>This requires some explanations:</p>
<ul>
<li>
<code>-Wall</code>: Enables all warnings.</li>
<li>
<code>-O0</code>: Disables optimizations for debugging purposes.
Otherwise, the compiler will adjust the package compiled binaries for
speedups, making it harder to debug. Once your code is working, you can
switch to <code>-O2</code> or <code>-O3</code> to enable optimizations
for production. If you plan to submit the package to CRAN, remove the
flag, as they do not accept it.</li>
<li>
<code>-pedantic</code>: Enforces strict ISO C++ compliance. This
will warn about improper writing, similar to bad grammar or spelling
errors in English.</li>
<li>
<code>-UDEBUG -g</code>: Disables the <code>DEBUG</code> macro and
enables debugging information. When a package is ready, <code>-g</code>
can be removed to reduce the size of the compiled binaries.</li>
</ul>
<p>In case that the “pedantic” part is not clear, here is an
example:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="pp">#include </span><span class="im">"cpp4r.hpp"</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;numeric&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> cpp4r<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">// Non-ISO: Use a variable length array</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> <span class="dt">double</span> <span class="va">squared_sum_non_iso_</span><span class="op">(</span>integers inp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>  <span class="dt">int</span> size <span class="op">=</span> inp<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>  <span class="dt">double</span> array<span class="op">[</span>size<span class="op">];</span>  <span class="co">// will give a warning, but still compile</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>    array<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> inp<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> inp<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>accumulate<span class="op">(</span>array<span class="op">,</span> array <span class="op">+</span> size<span class="op">,</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">// ISO: Use a vector</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> <span class="dt">double</span> <span class="va">squared_sum_iso_</span><span class="op">(</span>integers inp<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>  <span class="dt">int</span> size <span class="op">=</span> inp<span class="op">.</span>size<span class="op">();</span></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> vec<span class="op">(</span>size<span class="op">);</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> size<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>    vec<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> inp<span class="op">[</span>i<span class="op">]</span> <span class="op">*</span> inp<span class="op">[</span>i<span class="op">];</span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>accumulate<span class="op">(</span>vec<span class="op">.</span>begin<span class="op">(),</span> vec<span class="op">.</span>end<span class="op">(),</span> <span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Even when the code compiles, it gives a warning:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="ex">code.cpp:489:10:</span> warning: ISO C++ forbids variable length array ‘array’ <span class="pp">[-</span><span class="ss">Wvla</span><span class="pp">]</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>  <span class="ex">489</span> <span class="kw">|</span>   <span class="ex">double</span> array<span class="pp">[</span><span class="ss">size</span><span class="pp">]</span><span class="kw">;</span>  <span class="ex">//</span> will give a warning, but still compile</span></code></pre></div>
<p>It is possible to verify that the functions are correct:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.equal.html">all.equal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, <span class="fu">squared_sum_non_iso_</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, <span class="fu">squared_sum_iso_</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="testing-for-memory-leaks">Testing for Memory Leaks<a class="anchor" aria-label="anchor" href="#testing-for-memory-leaks"></a>
</h2>
<p>To test for memory leaks, you can use the <code>valgrind</code> tool.
This tool is available on Linux and macOS.</p>
<p>You can test for memory leaks by running the following command in the
terminal:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">valgrind</span> <span class="at">--leak-check</span><span class="op">=</span>full Rscript <span class="at">-e</span> <span class="st">"library(cpp4rexamples); squared_sum_iso_(1:5)"</span></span></code></pre></div>
<p>Or, alternatively, to call R in vanilla mode:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="ex">R</span> <span class="at">--vanilla</span> <span class="at">-d</span> <span class="st">'valgrind -s --track-origins=yes'</span> <span class="at">-f</span> test.R</span></code></pre></div>
<p>with <code>test.R</code> containing:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cpp4rexamples</span><span class="op">)</span></span>
<span><span class="fu">squared_sum_iso_</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="adding-a-configure-script">Adding a configure script<a class="anchor" aria-label="anchor" href="#adding-a-configure-script"></a>
</h2>
<p>For a portable package, it is recommended to add a
<code>configure</code> script. This script will check for the necessary
tools to build the package. The script is written in <code>bash</code>
and is placed in the <code>configure</code> file in the package root
directory.</p>
<p>Here is an example of a <code>configure</code> script for the
<code>cpp4rexamples</code> package:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="va">PKG_CONFIG_NAME</span><span class="op">=</span><span class="st">"gccsanissue"</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="ex">pkg-config</span> <span class="at">--version</span> <span class="op">&gt;</span>/dev/null <span class="dv">2</span><span class="op">&gt;&amp;</span><span class="dv">1</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$?</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="va">PKGCONFIG_CFLAGS</span><span class="op">=</span><span class="kw">`</span><span class="ex">pkg-config</span> <span class="at">--cflags</span> <span class="at">--silence-errors</span><span class="kw">`</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="va">PKGCONFIG_LIBS</span><span class="op">=</span><span class="kw">`</span><span class="ex">pkg-config</span> <span class="at">--libs</span><span class="kw">`</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$PKGCONFIG_CFLAGS</span><span class="st">"</span> <span class="bu">]</span> <span class="kw">||</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$PKGCONFIG_LIBS</span><span class="st">"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  <span class="bu">echo</span> <span class="st">"Found pkg-config cflags and libs!"</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  <span class="va">PKG_CFLAGS</span><span class="op">=</span><span class="va">${PKGCONFIG_CFLAGS}</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  <span class="va">PKG_LIBS</span><span class="op">=</span><span class="va">${PKGCONFIG_LIBS}</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="va">CXXFLAGS</span><span class="op">=</span><span class="st">"-stdlib=libc++"</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a><span class="co"># CXXFLAGS="-O0 -g -stdlib=libc++"</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="va">LDFLAGS</span><span class="op">=</span><span class="st">"-stdlib=libc++"</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="fu">sed</span> <span class="at">-e</span> <span class="st">"s|@cxxflags@|</span><span class="va">$CXXFLAGS</span><span class="st">|"</span> <span class="dt">\</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="at">-e</span> <span class="st">"s|@ldflags@|</span><span class="va">$LDFLAGS</span><span class="st">|"</span> <span class="dt">\</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>    src/Makevars.in <span class="op">&gt;</span> src/Makevars</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a><span class="bu">exit</span> 0</span></code></pre></div>
<p>This file, meant for Unix systems, must be accompanied by an
<code>configure.win</code> file for Windows systems.</p>
<p>Besides the configure script, an <code>src/Makevars.in</code> file
must be created. This file is a template for the
<code>src/Makevars</code> file. Here is an example:</p>
<pre><code>LDFLAGS=@ldflags@

# Convert source files to object files
SOURCES = code.cpp \
                    cpp4r.cpp
OBJECTS = $(SOURCES:.cpp=.o)

all: $(SHLIB)

$(SHLIB): $(OBJECTS)

clean: rm -f $(OBJECTS) $(SHLIB)</code></pre>
<p><code>Makevars.in</code> is also for Unix systems, and it must be
accompanied by an empty <code>Makevars.win</code> for Windows
systems.</p>
<p>Finally, a <code>cleanup</code> script helps to get a tidy package
build. Here is an example:</p>
<pre><code>#!/bin/sh
rm -f src/Makevars configure.log</code></pre>
<p>The advantage of this approach is that it will create a
<code>src/Makevars</code> file with the correct flags for the system.
This way, the package will be portable and easier to test with GitHub
Actions or Docker.</p>
</div>
<div class="section level2">
<h2 id="testing-with-docker">Testing with Docker<a class="anchor" aria-label="anchor" href="#testing-with-docker"></a>
</h2>
<p>CRAN checks packages on different Unix platforms, and additional
tests for compiled code include testing for memory leaks with valgrind
and address sanitizer.</p>
<p>Derived from the recommendations made by Dr. Krylov and
Dr. Eddelbuettel in the R-pkg-devel mailing list, you can create the
following script to test the package in a Docker container:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">#!/bin/sh</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="va">PACKAGE_DIR</span><span class="op">=</span><span class="va">$(</span><span class="bu">pwd</span><span class="va">)</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># DOCKER_IMAGE="ghcr.io/r-hub/containers/valgrind:latest"</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="va">DOCKER_IMAGE</span><span class="op">=</span><span class="st">"ghcr.io/r-hub/containers/clang-asan:latest"</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="ex">docker</span> pull <span class="va">$DOCKER_IMAGE</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">--rm</span> <span class="at">-v</span> <span class="st">"</span><span class="va">$PACKAGE_DIR</span><span class="st">"</span>:/workspace <span class="at">-w</span> /workspace <span class="va">$DOCKER_IMAGE</span> bash <span class="at">-c</span> <span class="st">"</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="st">  Rscript -e 'install.packages(</span><span class="dt">\"</span><span class="st">cpp4r</span><span class="dt">\"</span><span class="st">, repos=</span><span class="dt">\"</span><span class="st">https://cran.rstudio.com/</span><span class="dt">\"</span><span class="st">)'</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="st">  R CMD build .</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="st">  R CMD check --as-cran --no-manual gccsanissue_0.1.0.tar.gz</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="st">"</span></span></code></pre></div>
<p>You can add the following function to <code>cpp4rexamples</code>:</p>
<pre><code>[[cpp4r::register]] int bad_() {
  int x = 42;    // valid integer
  int *ptr = &amp;x; // pointer to `x`

  // undefined behavior (alignment issue)
  auto misaligned_ptr = reinterpret_cast&lt;long*&gt;(ptr);
  return *misaligned_ptr; // Read through misaligned pointer
}</code></pre>
<p>To access the function from the R session, you can add the following
R code:</p>
<pre><code><span><span class="co">#' @title Bad function</span></span>
<span><span class="co">#' @description This function has a GCC SAN issue</span></span>
<span><span class="co">#' @export </span></span>
<span><span class="co">#' @examples </span></span>
<span><span class="co">#' bad()</span></span>
<span><span class="va">bad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">bad_</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre>
<p>The function <code>bad_</code> introduces undefined behavior by
reading through a misaligned pointer. This is a common issue in C++
code, and it is a good example to test the address sanitizer.</p>
<p><code>reinterpret_cast&lt;long*&gt;</code> creates a misaligned
pointer since <code>ptr</code> is aligned for <code>int</code>, not
<code>long</code>. The pointer dereference <code>*misaligned_ptr</code>
introduces an undefined behavior. Without sanitizers, this will silently
execute, and it returns the value of <code>x</code>. With sanitizers, it
will throw an error.</p>
<p>When testing with the valgrind container and the command
<code>bash dev/test-docker.sh</code>, the R checks will pass, but the
valgrind check will fail with the following error:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="ex">Shadow</span> bytes around the buggy address:</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="ex">0x6ffdc4008d80:</span> 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="ex">Shadow</span> byte legend <span class="er">(</span><span class="ex">one</span> shadow byte represents 8 application bytes<span class="kw">)</span><span class="bu">:</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="ex">Addressable:</span>           00</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  <span class="ex">Partially</span> addressable: 01 02 03 04 05 06 07 </span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  <span class="ex">Heap</span> left redzone:       fa</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="ex">Freed</span> heap region:       fd</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="ex">Stack</span> left redzone:      f1</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="ex">Stack</span> mid redzone:       f2</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  <span class="ex">Stack</span> right redzone:     f3</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  <span class="ex">Stack</span> after return:      f5</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  <span class="ex">Stack</span> use after scope:   f8</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  <span class="ex">Global</span> redzone:          f9</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  <span class="ex">Global</span> init order:       f6</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  <span class="ex">Poisoned</span> by user:        f7</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="ex">Container</span> overflow:      fc</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  <span class="ex">Array</span> cookie:            ac</span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="ex">Intra</span> object redzone:    bb</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  <span class="ex">ASan</span> internal:           fe</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  <span class="ex">Left</span> alloca redzone:     ca</span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  <span class="ex">Right</span> alloca redzone:    cb</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a><span class="ex">==1244==ABORTING</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Mauricio Vargas Sepulveda, Posit Software, PBC.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
